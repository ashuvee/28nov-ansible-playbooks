---
- name: Install Jenkins
  hosts: jenkins
  become: true

  vars:
    jenkins_port: 8080
    java_package: openjdk-21-jre

  tasks:
    - name: Install Java and dependencies
      apt:
        name: ["{{ java_package }}", gnupg, curl, apt-transport-https]
        state: present
        update_cache: true

    - name: Install Ansible
      apt:
        name: ansible
        state: present
        update_cache: true

    - name: Verify Ansible installation
      command: ansible-playbook --version
      register: ansible_version
      changed_when: false

    - name: Add Jenkins key and repo
      block:
        - name: Download key
          get_url:
            url: https://pkg.jenkins.io/debian/jenkins.io-2023.key
            dest: /usr/share/keyrings/jenkins-keyring.asc
            mode: '0644'
        - name: Add repo
          apt_repository:
            repo: "deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc] https://pkg.jenkins.io/debian binary/"
            filename: jenkins
            state: present

    - name: Install Jenkins
      apt:
        name: jenkins
        state: present
        update_cache: true

    - name: Start Jenkins Service
      systemd:
        name: jenkins
        state: started
        enabled: true

    - name: Wait for Jenkins to start
      wait_for:
        port: "{{ jenkins_port }}"
        timeout: 60

    - name: Get Admin Password
      slurp:
        src: /var/lib/jenkins/secrets/initialAdminPassword
      register: admin_pass
      ignore_errors: true

    - name: Show Jenkins Info
      debug:
        msg:
          - "URL: http://{{ ansible_default_ipv4.address }}:{{ jenkins_port }}"
          - "Password: {{ admin_pass.content | b64decode | trim if admin_pass.content is defined else 'Not found (check /var/lib/jenkins/secrets/initialAdminPassword)' }}"
